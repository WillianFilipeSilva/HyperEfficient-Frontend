# Prompt Completo Sistema HyperEfficient - Versão Atualizada 2025

## Visão Geral do Projeto
HyperEfficient é um sistema completo de gestão de gastos elétricos empresariais desenvolvido como projeto acadêmico para o curso Entra21 (turma C). O sistema permite monitorar equipamentos, registrar consumo energético, gerar relatórios e controlar custos por setor com uma arquitetura moderna e modular. Inclui integração com dispositivos inteligentes Tuya para monitoramento em tempo real.

## Arquitetura e Stack Tecnológica

**Sempre seguir princípios DRY (Don't Repeat Yourself) - sempre fazer código para reutilizar**

### Backend - API REST
- **Framework:** ASP.NET Core (C#)
- **Arquitetura:** Domain Driven Design (DDD) organizado por pastas
- **ORM:** Dapper (microORM com SQL nativo)
- **Banco:** MySQL 8.0+ com charset utf8mb4_unicode_ci
- **Autenticação:** JWT Bearer Token
- **Criptografia:** PBKDF2 para senhas
- **Padrões:** Repository Pattern + Service Layer
- **Logs:** ILogger integrado
- **Validação:** Data Annotations nos DTOs
- **Integração:** Tuya API para dispositivos inteligentes
- **Background Services:** IHostedService para atualizações periódicas

### Frontend - SPA Vanilla
- **Core:** HTML5 + Vanilla JavaScript + Tailwind CSS
- **Layout:** CSS Grid responsivo e componentizado
- **Build:** Arquivos estáticos servidos diretamente (sem bundlers)
- **Componentes:** Modulares reutilizáveis em JavaScript
- **Estado:** localStorage para JWT + variáveis globais
- **HTTP:** Fetch API nativo para comunicação com backend
- **Utilitários:** Biblioteca Utils.js com funções auxiliares extensivas
- **Autenticação:** Sistema AuthGuard centralizado para proteção de rotas
- **Charts:** Chart.js para gráficos de consumo energético

### Banco de Dados - MySQL
- **Schema:** `hyperefficient`
- **Engine:** InnoDB
- **Versionamento:** Scripts SQL manuais (sem migrations)
- **Convenções:** Tabelas/campos UPPERCASE, entidades PascalCase
- **Tipos:** DOUBLE para valores de potência e energia (kWh)

## Estrutura Completa do Backend

### Organização de Pastas

```
HyperEfficient/ (Pasta raiz do backend)
├── Contracts/ (Interfaces e contratos)
│   ├── Infrastructure/
│   │   ├── IConnection.cs
│   │   └── IAutentication.cs
│   ├── Repositories/
│   │   ├── IUsuarioRepository.cs
│   │   ├── ICategoriaRepository.cs
│   │   ├── IEquipamentoRepository.cs
│   │   ├── ISetorRepository.cs
│   │   ├── IRegistroRepository.cs
│   │   └── IRelatorioRepository.cs
│   └── Services/
│       ├── IUsuarioService.cs
│       ├── ICategoriaService.cs
│       ├── IEquipamentoService.cs
│       ├── ISetorService.cs
│       ├── IRegistroService.cs
│       ├── IRelatorioService.cs
│       └── ITuyaApiClientService.cs
├── Controllers/ (Endpoints da API)
│   ├── UsuarioController.cs
│   ├── CategoriaController.cs
│   ├── EquipamentoController.cs
│   ├── SetorController.cs
│   ├── RegistroController.cs
│   └── RelatorioController.cs
├── Dtos/ (Data Transfer Objects)
│   ├── Base/
│   │   ├── BaseDto.cs
│   │   └── GetAllResponseBase.cs
│   ├── Usuario/
│   │   ├── UsuarioDto.cs
│   │   ├── UsuarioInsertDto.cs
│   │   ├── UsuarioLoginDto.cs
│   │   ├── UsuarioLoginTokenDto.cs
│   │   └── UsuarioGetAllResponse.cs
│   ├── Categoria/
│   ├── Equipamento/
│   │   ├── EquipamentoDto.cs
│   │   ├── EquipamentoInsertDto.cs
│   │   ├── EquipamentoGetAllResponse.cs
│   │   └── EquipamentoStatusDto.cs
│   ├── Setor/
│   ├── Registro/
│   │   ├── RegistroDto.cs
│   │   ├── RegistroInsertDto.cs
│   │   └── RegistroGetAllResponse.cs
│   ├── Relatorios/
│   │   ├── RelatorioEmpresaResponse.cs
│   │   ├── TotalizadoresDto.cs
│   │   ├── DadosMensaisDto.cs
│   │   ├── SetorResumoDto.cs
│   │   └── CategoriaResumoDto.cs
│   └── MessageResponse/
│       └── MessageResponse.cs
├── Entities/ (Modelos de domínio)
│   ├── Base/
│   │   └── EntityBase.cs
│   ├── UsuarioEntity.cs
│   ├── CategoriaEntity.cs
│   ├── EquipamentoEntity.cs
│   ├── SetorEntity.cs
│   └── RegistroEntity.cs
├── Infrastructure/ (Infraestrutura técnica)
│   ├── Authentication/
│   │   └── Autentication.cs
│   ├── Connection/
│   │   └── Connection.cs
│   ├── Criptography/
│   │   └── Criptography.cs
│   ├── DatabaseInitializer/
│   │   └── DatabaseInitializer.cs
│   ├── Extensions/
│   │   └── ServiceCollectionExtensions.cs
│   ├── Mapping/
│   │   ├── UsuarioProfile.cs
│   │   └── [outros profiles AutoMapper]
│   └── Middleware/
│       ├── ErrorHandlingMiddleware.cs
│       └── ErrorResponse.cs
├── Repositories/ (Acesso a dados)
│   ├── UsuarioRepository.cs
│   ├── CategoriaRepository.cs
│   ├── EquipamentoRepository.cs
│   ├── SetorRepository.cs
│   ├── RegistroRepository.cs
│   └── RelatorioRepository.cs
├── Services/ (Lógica de negócio)
│   ├── UsuarioService.cs
│   ├── CategoriaService.cs
│   ├── EquipamentoService.cs
│   ├── SetorService.cs
│   ├── RegistroService.cs
│   ├── RelatorioService.cs
│   ├── TuyaApiClientService.cs
│   └── BackgroundServices/
│       └── TuyaUpdateService.cs
├── appsettings.json
├── Program.cs
└── [arquivos de configuração]
```

## Estrutura Frontend Detalhada

### Estrutura de Arquivos Atualizada

```
HyperEfficient-frontEnd/
├── assets/
│   ├── css/
│   │   ├── dashboard-tailwind.css (Estilos principais)
│   │   ├── dashboard-specific.css (Estilos específicos do dashboard)
│   │   ├── auth-pages.css (Estilos das páginas de autenticação)
│   │   ├── listing-pages.css (Estilos das páginas de listagem)
│   │   ├── modal-styles.css (Estilos dos modais)
│   │   ├── global.css (Estilos globais)
│   │   ├── nucleo-icons.css (Ícones)
│   │   ├── nucleo-svg.css (SVG icons)
│   │   ├── perfect-scrollbar.css (Scrollbar customizada)
│   │   └── styles.css (Estilos personalizados)
│   ├── fonts/ (Nucleo icons + outras fontes)
│   ├── img/
│   │   └── logo.svg
│   └── js/
│       └── plugins/
│           ├── chartjs.min.js (Charts)
│           └── perfect-scrollbar.min.js (Scrollbar)
├── pages/
│   ├── auth/
│   │   ├── login.html (Página de login)
│   │   └── login.js (Lógica de login)
│   ├── dashboard/
│   │   ├── components/
│   │   │   └── dashboard-cards.js
│   │   ├── dashboard.html (Dashboard principal)
│   │   └── dashboard.js (Lógica do dashboard)
│   ├── shared/
│   │   ├── components/
│   │   │   ├── modal.js
│   │   │   ├── table.js
│   │   │   ├── sidebar.html
│   │   │   └── sidebar.js
│   │   └── services/
│   │       ├── api.js (Configuração da API)
│   │       ├── utils.js (Utilitários gerais - CRÍTICO)
│   │       └── auth-guard.js (Sistema de autenticação - NOVO)
│   ├── usuarios/
│   │   ├── cadastro/
│   │   │   ├── cadastro.html (Cadastro de usuários)
│   │   │   └── cadastro.js (Lógica de cadastro)
│   │   ├── perfil.html (Perfil do usuário)
│   │   └── perfil.js (Lógica do perfil)
│   ├── setores/
│   │   ├── listar-setores.html (Gestão de setores)
│   │   └── listar-setores.js (Lógica de setores)
│   ├── categorias/
│   │   ├── listar-categorias.html (Gestão de categorias)
│   │   └── listar-categorias.js (Lógica de categorias)
│   └── equipamentos/
│       ├── listar-equipamentos.html (Gestão de equipamentos)
│       └── listar-equipamentos.js (Lógica de equipamentos)
├── Backend/ (Pasta do backend)
├── package.json
├── postcss.config.js
├── tailwind.config.js
├── README-API.md
├── Requisitos.txt
└── .gitignore
```

## Sistema de Autenticação Frontend - AuthGuard (NOVO)

### Arquivo: `pages/shared/services/auth-guard.js`

Sistema centralizado de proteção de rotas que substitui código duplicado em todas as páginas:

```javascript
// Inicialização automática
initAuthGuard();

// Funcionalidades:
- Detecção automática de páginas públicas vs protegidas
- Validação de token em tempo real
- Redirecionamento inteligente baseado no status de autenticação
- Verificação periódica de expiração do token
- Mensagens de feedback para o usuário
- Configuração flexível por página

// Páginas públicas (não precisam de autenticação):
- /pages/auth/login.html
- /pages/usuarios/cadastro.html

// Páginas protegidas (precisam de autenticação):
- /pages/dashboard/
- /pages/usuarios/ (exceto cadastro.html)
- /pages/setores/
- /pages/categorias/
- /pages/equipamentos/
```

## Biblioteca Utils.js - Componente Crítico

### Funcionalidades Principais
A biblioteca `utils.js` é o coração do frontend, fornecendo:

#### 1. Validações Robustas
```javascript
// Validações específicas
Utils.isValidEmail(email)            // Regex para email
Utils.isValidPassword(senha)         // Mínimo 6 caracteres
Utils.isValidName(nome)             // Mínimo 2 caracteres
Utils.isRequired(value)             // Campo obrigatório

// Validação de formulários completos
Utils.validateForm(formData, validations)
```

#### 2. UI/UX Avançada
```javascript
// Gerenciamento de estados visuais
Utils.showError(elementId, message)
Utils.hideError(elementId)
Utils.showButtonLoading(buttonId, loadingText)
Utils.hideButtonLoading(buttonId)

// Sistema de notificações Toast
Utils.showToast(message, type, duration)
// Tipos: 'success', 'error', 'warning', 'info'
```

#### 3. Modal System Genérico
```javascript
Utils.showModal({
    message: 'Confirma exclusão?',
    title: 'Confirmação',
    onConfirm: () => { /* ação */ },
    onCancel: () => { /* cancelar */ }
})
```

#### 4. Formatação de Dados
```javascript
Utils.formatDate(date, 'dd/mm/yyyy')
Utils.formatCurrency(value, 'R$')      // R$ 1.234,56
Utils.formatNumber(value, decimals)      // 1.234,56
```

#### 5. Manipulação DOM
```javascript
Utils.showElement(elementId)
Utils.hideElement(elementId)
Utils.toggleElement(elementId)
```

#### 6. Utilidades de String
```javascript
Utils.capitalize(str)                  // Primeira letra maiúscula
Utils.getInitials(name, maxLength)     // Iniciais do nome
Utils.truncate(str, maxLength)         // Truncar texto
Utils.removeAccents(str)               // Remove acentos
```

#### 7. Manipulação de Arrays/Objetos
```javascript
Utils.filterByProperty(array, property, value)
Utils.sortByProperty(array, property, ascending)
```

#### 8. Storage Management
```javascript
Utils.saveToStorage(key, value)        // localStorage
Utils.loadFromStorage(key, defaultValue)
Utils.removeFromStorage(key)
```

#### 9. Performance Optimization
```javascript
Utils.debounce(func, wait)             // Debounce de funções
Utils.throttle(func, limit)            // Throttle de funções
```

#### 10. Navegação
```javascript
Utils.redirect(url, delay)
Utils.isCurrentPage(pageName)
```

## Configuração da API - api.js (NOVO)

### Arquivo: `pages/shared/services/api.js`

```javascript
const API_CONFIG = {
    BASE_URL: 'http://localhost:5205',
    ENDPOINTS: {
        LOGIN: '/usuarios/login',
        CADASTRO: '/usuarios',
        USUARIOS: '/usuarios',
        SETORES: '/setores',
        CATEGORIAS: '/categorias',
        EQUIPAMENTOS: '/equipamentos',
        REGISTROS: '/registros',
        RELATORIOS: '/relatorios'
    },
    
    // Funções para requisições autenticadas e públicas
    authenticatedRequest(url, options)
    publicRequest(url, options)
}

const AuthUtils = {
    isLoggedIn()
    getCurrentUser()
    logout()
    isTokenExpired()
}
```

## Modelo de Dados Completo

### Tabelas e Relacionamentos
```sql
-- USUARIO (Autenticação e controle de acesso)
Usuario {
  Id: INT PRIMARY KEY AUTO_INCREMENT
  Nome: VARCHAR(100) NOT NULL
  CriadoEm: DATETIME NOT NULL
  Senha: VARCHAR(255)  -- Hash PBKDF2
  Email: VARCHAR(150) UNIQUE
  Ativo: TINYINT DEFAULT 1
}

-- CATEGORIA (Classificação de equipamentos)
Categoria {
  Id: INT PRIMARY KEY AUTO_INCREMENT
  Nome: VARCHAR(100) NOT NULL
}

-- SETOR (Divisões da empresa)
Setor {
  Id: INT PRIMARY KEY AUTO_INCREMENT
  GastoGeral: DOUBLE
  Nome: VARCHAR(100)
}

-- EQUIPAMENTO (Dispositivos monitorados)
Equipamento {
  Id: INT PRIMARY KEY AUTO_INCREMENT
  Nome: VARCHAR(100) NOT NULL
  Descricao: VARCHAR(300)
  PotenciaKwh: DOUBLE NOT NULL  -- Consumo por hora
  DeviceIdIntegration: VARCHAR(100)  -- ID do dispositivo Tuya
  CategoriaId: INT FK > Categoria.Id
  SetorId: INT FK > Setor.Id
  Ativo: TINYINT DEFAULT 1
}

-- REGISTRO (Histórico de uso dos equipamentos)
Registro {
  Id: INT PRIMARY KEY AUTO_INCREMENT
  DataInicial: DATETIME NOT NULL
  DataFinal: DATETIME  -- Null = ainda em uso
  EquipamentoId: INT FK > Equipamento.Id
  TotalKwh: DOUBLE NOT NULL DEFAULT 0  -- Total de kWh consumido
  TotalTempo: DOUBLE GENERATED ALWAYS AS (
    IF(DataFinal IS NOT NULL, TIMESTAMPDIFF(SECOND, DataInicial, DataFinal) / 3600, NULL)
  ) STORED
}
```

## Integração com Tuya API

### Funcionalidades Implementadas

#### 1. TuyaApiClientService
```csharp
public interface ITuyaApiClientService
{
    Task<EquipamentoStatusDto> GetStatusAsync(string deviceId);
    Task LigarAsync(int equipamentoId);
    Task DesligarAsync(int equipamentoId);
}

// Funcionalidades:
- Autenticação HMAC-SHA256 com nonce UUID
- Obtenção de status em tempo real dos dispositivos
- Controle remoto de ligar/desligar
- Tratamento de erros de autenticação
- Cache de token de acesso
```

#### 2. Sistema de Registros Inteligente
```csharp
// RegistroService.cs
public async Task<MessageResponse> StartStopRegistro(int equipamentoId)
{
    // Atualiza dados do equipamento antes de iniciar/parar
    await _equipamentoService.AtualizarConsumoEquipamento(equipamentoId);
    
    // Lógica de start/stop com sincronização
}

// Cálculo de consumo:
// - Com DeviceIdIntegration: usa dados reais da Tuya API
// - Sem DeviceIdIntegration: calcula com base na potência informada
```

#### 3. Background Service
```csharp
// TuyaUpdateService.cs
public class TuyaUpdateService : BackgroundService
{
    // Atualiza equipamentos com integração Tuya a cada 3 horas
    // Mantém dados de potência e status atualizados
    // Evita sobrecarga da API Tuya
}
```

## Dashboard e Relatórios

### Funcionalidades do Dashboard
```javascript
// dashboard.js
- Seleção de período (data inicial/final)
- Cards com totalizadores animados
- Gráfico de consumo energético (Chart.js)
- Lista de setores ordenada por consumo
- Lista de categorias ordenada por consumo
- Validação de período máximo (1 ano)
- Persistência de filtros na sessão
```

### Relatórios Backend
```csharp
// RelatorioService.cs
public async Task<RelatorioEmpresaResponse> GetRelatorioEmpresa(DateTime dataInicio, DateTime dataFim)
{
    return new RelatorioEmpresaResponse
    {
        Totalizadores = await _relatorioRepository.GetTotalizadores(dataInicio, dataFim),
        DadosMensais = await _relatorioRepository.GetDadosMensais(dataInicio, dataFim),
        Setores = await _relatorioRepository.GetSetorResumo(dataInicio, dataFim),
        Categorias = await _relatorioRepository.GetCategoriaResumo(dataInicio, dataFim)
    };
}
```

### Consultas SQL Otimizadas
```sql
-- Cálculo de consumo considerando registros ativos e finalizados
-- Períodos parciais calculados corretamente
-- Agrupamento por setor e categoria
-- Ordenação por consumo total
```

## Padrões de Código e Convenções

### Controllers (Endpoints da API)
```csharp
[ApiController]
[Route("relatorios")]  // Sempre plural, lowercase
public class RelatoriosController : ControllerBase
{
    // Padrão: Apenas delegam para Services
    // Sempre retornam Ok(resultado)
    // DTOs para entrada, Entities/DTOs para saída
    // [Authorize] em tudo, exceto [AllowAnonymous] no login
    
    [HttpGet("empresa")]
    [Authorize]
    public async Task<ActionResult<RelatorioEmpresaResponse>> Empresa(
        [FromQuery] DateTime dataInicio, [FromQuery] DateTime dataFim)
    {
        return Ok(await _relatorioService.GetRelatorioEmpresa(dataInicio, dataFim));
    }
}
```

### Services (Lógica de Negócio)
```csharp
public class RegistroService : ServiceBase<Registro>, IRegistroService
{
    // Responsabilidades:
    // - Validações de negócio
    // - Integração com Tuya API
    // - Cálculos de consumo energético
    // - Sincronização de dados
    // - Tratamento de exceções
    
    public async Task<MessageResponse> StartStopRegistro(int equipamentoId)
    public async Task<EquipamentoStatusDto> ObterConsumoAsync(int equipamentoId)
    public async Task LigarAsync(int equipamentoId)
    public async Task DesligarAsync(int equipamentoId)
}
```

### Repositories (Acesso a Dados)
```csharp
public class RelatorioRepository : IRelatorioRepository
{
    // Métodos para relatórios:
    // GetTotalizadores(dataInicio, dataFim)
    // GetDadosMensais(dataInicio, dataFim)
    // GetSetorResumo(dataInicio, dataFim)
    // GetCategoriaResumo(dataInicio, dataFim)
    
    // SQL sempre nativo com Dapper
    // Campos DB em UPPERCASE, propriedades em PascalCase
    // Parâmetros sempre nomeados (@param)
}
```

### DTOs (Transferência de Dados)
```csharp
// EquipamentoStatusDto: Status em tempo real
public class EquipamentoStatusDto
{
    public double PotenciaKwh { get; set; }
    public double TotalKwh { get; set; }
    public bool Ligado { get; set; }
}

// RelatorioEmpresaResponse: Dados do dashboard
public class RelatorioEmpresaResponse
{
    public TotalizadoresDto Totalizadores { get; set; }
    public List<DadosMensaisDto> DadosMensais { get; set; }
    public List<SetorResumoDto> Setores { get; set; }
    public List<CategoriaResumoDto> Categorias { get; set; }
}
```

## Configuração e Inicialização

### appsettings.json
```json
{
  "ConnectionStrings": {
    "Default": "Server=localhost;Port=3306;Database=hyperefficient;User=root;Password=root"
  },
  "JwtSettings": {
    "SecretKey": "zjcvbnoDmkKeugcBfkoxcmZCqDbBlWJw"
  },
  "TuyaApi": {
    "ClientId": "your_client_id",
    "ClientSecret": "your_client_secret",
    "BaseUrl": "https://openapi.tuyaeu.com"
  }
}
```

### Program.cs - Pipeline Completo
```csharp
// 1. Services registration
builder.Services.AddControllers();
builder.Services.AddSwaggerGen(/* JWT Bearer config */);
builder.Services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme);
builder.Services.AddSingleton<IConnection, Connection>();
builder.Services.AddScoped<IAutentication, Autentication>();
builder.Services.AddCamadaInfra().AddCamadaAplicacao();  // Extension methods
builder.Services.AddAutoMapper(AppDomain.CurrentDomain.GetAssemblies());

// 2. Background Services
builder.Services.AddHostedService<TuyaUpdateService>();

// 3. Database initialization
EnsureDatabaseAndTablesCreated(connection, configuration);

// 4. Middleware pipeline
app.UseHttpsRedirection();
app.UseMiddleware<ErrorHandlingMiddleware>();  // Custom error handling
app.UseAuthentication();  // ANTES do Authorization!
app.UseAuthorization();
app.MapControllers();
```

## Funcionalidades do Sistema

### Módulo de Usuários
- Cadastro com validação de email único
- Login com JWT (24h de validade)
- CRUD completo com soft delete (campo Ativo)
- Criptografia PBKDF2 para senhas

### Módulo de Equipamentos
- Cadastro com categoria e setor obrigatórios
- Campo PotenciaKwh para cálculo de consumo
- Integração opcional com dispositivos Tuya (DeviceIdIntegration)
- Relacionamento com Categoria e Setor
- Status ativo/inativo
- Atualização automática de dados via Tuya API

### Módulo de Registros
- Início/fim de uso de equipamentos
- DataFinal null = equipamento ainda em uso
- Cálculo automático de TotalKwh
- Integração com dados reais da Tuya API
- Base para cálculos de consumo e relatórios

### Módulo de Relatórios
- Dashboard com período selecionável
- Consumo por setor com ordenação
- Consumo por categoria com ordenação
- Gráfico de evolução do consumo
- Totalizadores animados
- Histórico de registros

### Módulo de Setores
- Gestão de setores da empresa
- Cálculo de gasto geral por setor
- Interface de listagem e edição

### Módulo de Categorias
- Gestão de categorias de equipamentos
- Interface de listagem e edição

## Tratamento de Erros

### ErrorHandlingMiddleware
```csharp
// Tipos de exceção mapeados:
// KeyNotFoundException > 404 Not Found
// ArgumentException > 400 Bad Request  
// UnauthorizedAccessException > 401 Unauthorized
// InvalidOperationException > 400 Bad Request
// Exception (genérica) > 500 Internal Server Error

// Formato de resposta:
{
  "statusCode": 404,
  "message": "Usuário não encontrado!",
  "details": "Recurso não encontrado", 
  "timestamp": "2025-01-26T..."
}
```

## Frontend - Arquitetura de Componentes

### Estrutura Modular
```javascript
// Componentes reutilizáveis
const Modal = {
    show: (content) => {},
    hide: () => {},
    confirm: (message, callback) => {}
};

const Table = {
    render: (data, columns, actions) => {},
    paginate: (data, page, size) => {}
};

// Services para API
const ApiService = {
    baseURL: 'http://localhost:5205',
    token: localStorage.getItem('token'),
    get: (endpoint) => {},
    post: (endpoint, data) => {},
    put: (endpoint, data) => {},
    delete: (endpoint) => {}
};
```

### Sistema de Autenticação Frontend
```javascript
// AuthGuard.js (NOVO)
const AuthGuard = {
    init: (options) => {},
    checkAuth: () => {},
    checkAuthPublic: () => {},
    redirectToLogin: () => {},
    redirectToDashboard: () => {},
    handleTokenExpired: () => {},
    startTokenCheck: () => {}
};

// AuthUtils.js
const AuthUtils = {
    login: async (email, senha) => {
        // POST /usuarios/login
        // Salva token no localStorage
        // Redireciona para dashboard
    },
    logout: () => {
        // Remove token
        // Redireciona para login
    },
    isAuthenticated: () => {
        // Verifica se token existe e é válido
    },
    getUser: () => {
        // Decode JWT payload
    }
};
```

## Padrões de Desenvolvimento Frontend

### Uso da Biblioteca Utils.js
```javascript
// SEMPRE usar Utils.js para:
// 1. Validações de formulário
const validation = Utils.validateForm(formData, {
    nome: { required: true, minLength: 2 },
    email: { required: true, email: true },
    senha: { required: true, minLength: 6 }
});

// 2. Feedback visual
Utils.showToast('Usuário criado com sucesso!', 'success');
Utils.showButtonLoading('btnSalvar', 'Salvando...');

// 3. Confirmações
Utils.showModal({
    message: 'Deseja excluir este usuário?',
    title: 'Confirmar Exclusão',
    onConfirm: () => deleteUser(id)
});

// 4. Formatação de dados
Utils.formatCurrency(consumo * tarifa);
Utils.formatDate(registro.dataInicial);
```

### Estrutura de Páginas HTML
```html
<!-- Sempre incluir na ordem: -->
<link href="/assets/css/nucleo-icons.css" rel="stylesheet" />
<link href="/assets/css/nucleo-svg.css" rel="stylesheet" />
<link href="/assets/css/dashboard-tailwind.css" rel="stylesheet" />

<!-- Scripts sempre no final: -->
<script src="/pages/shared/services/utils.js"></script>
<script src="/pages/shared/services/api.js"></script>
<script src="/pages/shared/services/auth-guard.js"></script>
<script src="/pages/shared/components/sidebar.js"></script>
<script src="/pages/dashboard/components/dashboard-cards.js"></script>

<!-- Inicialização: -->
<script>
    initAuthGuard();
    // Resto do código da página
</script>
```

## Regras de Desenvolvimento

### Código Limpo (Clean Code)
- Nomes descritivos e em português para domínio de negócio
- Métodos pequenos com responsabilidade única
- NUNCA alterar nomes de métodos/variáveis existentes
- Evitar comentários óbvios no código
- Preferir composição sobre herança
- SEMPRE usar Utils.js para operações comuns
- SEMPRE usar AuthGuard para proteção de rotas

### Padrões de Resposta
- Sempre código completo quando solicitado
- Questionar quando algo não for possível
- Sugerir alternativas corretas
- Manter consistência com padrões existentes
- Integrar Utils.js em qualquer código frontend
- Usar AuthGuard para todas as páginas

### Validações
- Data Annotations nos DTOs de entrada
- Validações de negócio nos Services
- Controllers apenas delegam (não validam)
- Frontend usa Utils.validateForm() obrigatoriamente
- Exceções específicas para cada tipo de erro

### Segurança
- JWT em todos os endpoints (exceto login)
- Senhas sempre hasheadas (PBKDF2)
- CORS configurado apropriadamente
- Input sanitization via Data Annotations
- Token JWT gerenciado via Utils.js storage functions
- AuthGuard para proteção automática de rotas

## Observações Específicas

### Ambiente de Desenvolvimento
- Visual Studio ou VS Code
- MySQL Workbench para banco
- Postman/Insomnia para testes de API
- Browser Developer Tools para frontend
- Live Server ou similar para servir arquivos estáticos

### Deploy e Build
- Backend: dotnet publish
- Frontend: arquivos estáticos (sem build process)
- Banco: scripts manuais de criação/atualização
- CSS: Tailwind via CDN (sem compilação)

### Extensibilidade Futura
- Estrutura preparada para adicionar novos módulos
- Padrões consistentes facilitam manutenção
- Separação clara entre camadas
- Frontend modular permite crescimento
- Utils.js extensível para novas funcionalidades
- AuthGuard centralizado facilita adição de novas páginas

## Características Técnicas Críticas

### Frontend
- Sem transpilação: JavaScript vanilla ES6+
- Tailwind CSS: Via CDN, sem build process
- Componentes: Modulares em arquivos separados
- Estado: localStorage + variáveis globais
- Utils.js: Biblioteca central obrigatória para todas as operações
- AuthGuard: Sistema de autenticação centralizado obrigatório
- Chart.js: Para gráficos de consumo energético

### Backend
- Dapper: SQL nativo, sem ORM complexo
- DDD: Organização por domínio, não por tipo
- JWT: Autenticação stateless
- AutoMapper: Mapeamento automático entre camadas
- Middleware: Tratamento global de erros
- Tuya API: Integração com dispositivos inteligentes
- Background Services: Atualizações periódicas

### Integração
- API REST: Comunicação via JSON
- CORS: Configurado para desenvolvimento local
- Swagger: Documentação automática da API
- Logging: ILogger para rastreamento
- Tuya API: HMAC-SHA256 para autenticação

## Melhorias Implementadas (2025)

### Sistema de Autenticação Centralizado
- ✅ AuthGuard.js: Proteção automática de rotas
- ✅ Eliminação de código duplicado
- ✅ Detecção inteligente de páginas públicas vs protegidas
- ✅ Verificação periódica de token
- ✅ Redirecionamento automático

### Estrutura de Pastas Reorganizada
- ✅ Organização por funcionalidade (pages/auth, pages/dashboard, etc.)
- ✅ Serviços centralizados em pages/shared/services
- ✅ Componentes reutilizáveis em pages/shared/components
- ✅ Caminhos absolutos para evitar problemas de referência

### Biblioteca Utils.js Aprimorada
- ✅ Funções de formatação de moeda
- ✅ Sistema de toast notifications
- ✅ Validações robustas de formulários
- ✅ Manipulação avançada de DOM
- ✅ Utilitários de performance (debounce, throttle)

### Configuração de API Centralizada
- ✅ api.js: Configuração unificada da API
- ✅ AuthUtils: Utilitários de autenticação
- ✅ Endpoints organizados e documentados
- ✅ Tratamento de erros padronizado

### Integração com Tuya API
- ✅ TuyaApiClientService: Cliente para API Tuya
- ✅ Autenticação HMAC-SHA256 com nonce
- ✅ Obtenção de status em tempo real
- ✅ Controle remoto de dispositivos
- ✅ Background service para atualizações periódicas

### Sistema de Registros Inteligente
- ✅ Cálculo automático de consumo
- ✅ Integração com dados reais da Tuya API
- ✅ Fallback para equipamentos sem integração
- ✅ Armazenamento de TotalKwh nos registros

### Dashboard Completo
- ✅ Seleção de período com validação
- ✅ Cards animados com totalizadores
- ✅ Gráfico de consumo energético
- ✅ Listas ordenadas por consumo
- ✅ Persistência de filtros

## Funcionalidades e Endpoints Adicionados (2025)

### Backend
- **Endpoint `/usuarios/handshake`**: Permite ao frontend validar se o token JWT ainda é aceito pelo backend (usado para handshake/autenticação).
- **Login com campo `lembrarDeMim`**: O endpoint de login agora aceita o campo `lembrarDeMim` (boolean). Se true, o backend gera um token JWT com expiração maior (ex: 30 dias); se false, expiração padrão (ex: 2 horas).
- **Integração Tuya API**: Endpoints para controle e monitoramento de dispositivos inteligentes.
- **Background Service**: Atualização periódica de dados dos equipamentos Tuya.
- **Sistema de Registros**: Controle inteligente de início/fim de uso com cálculo automático de consumo.

### Frontend
- **Armazenamento do token**: O frontend salva o token e o usuário apenas no `localStorage`, independente do checkbox "Lembrar de mim".
- **Verificação periódica de token**: O frontend verifica a validade do token a cada 1 minuto usando o AuthGuard e o endpoint `/usuarios/handshake`.
- **Logout global**: O logout remove sempre o token/usuário do localStorage e redireciona para a tela de login.
- **Dashboard completo**: Interface moderna com gráficos, filtros e totalizadores.
- **Gestão de equipamentos**: Interface para cadastro e controle de equipamentos com integração Tuya.

Essas mudanças garantem maior segurança, controle de sessão, alinhamento entre frontend e backend para autenticação e expiração de sessão, além de funcionalidades avançadas de monitoramento energético.

### Organização dos Scripts de Login e Cadastro (2025)
- Todos os scripts de lógica de login e cadastro foram movidos para arquivos JavaScript externos:
  - `pages/auth/login.js` para o login
  - `pages/usuarios/cadastro.js` para o cadastro
- Não há mais nenhum script inline nos arquivos HTML dessas telas, seguindo boas práticas de separação de responsabilidades e facilitando manutenção e versionamento.

## 4. Entidades, Classes e Banco de Dados

### Banco de Dados (MySQL) e Entidades (C#)

- **Usuario / UsuarioEntity**
  - Id: INT/AUTO_INCREMENT (herdado de EntityBase)
  - Nome: VARCHAR(100) / string
  - CriadoEm: DATETIME / DateTime
  - Senha: VARCHAR(255) / string
  - Email: VARCHAR(150) / string
  - Ativo: TINYINT / bool

- **Categoria / CategoriaEntity**
  - Id: INT/AUTO_INCREMENT (herdado de EntityBase)
  - Nome: VARCHAR(100) / string

- **Setor / SetorEntity**
  - Id: INT/AUTO_INCREMENT (herdado de EntityBase)
  - GastoGeral: DOUBLE / double
  - Nome: VARCHAR(100) / string
  - Descricao: VARCHAR(300) / string

- **Equipamento / EquipamentoEntity**
  - Id: INT/AUTO_INCREMENT (herdado de EntityBase)
  - Nome: VARCHAR(100) / string
  - Descricao: VARCHAR(300) / string
  - PotenciaKwh: DOUBLE / double
  - DeviceIdIntegration: VARCHAR(100) / string
  - CategoriaId: INT / int
  - SetorId: INT / int
  - Ativo: TINYINT / bool

- **Registro / RegistroEntity**
  - Id: INT/AUTO_INCREMENT (herdado de EntityBase)
  - DataInicial: DATETIME / DateTime
  - DataFinal: DATETIME / DateTime
  - EquipamentoId: INT / int
  - TotalKwh: DOUBLE / double
  - TotalTempo: DOUBLE (GENERATED) / double

Este prompt captura completamente a essência, estrutura, padrões e especificidades técnicas do projeto HyperEfficient, incluindo a importância crítica da biblioteca Utils.js no frontend, o novo sistema AuthGuard para autenticação centralizada, a integração com Tuya API, o sistema de registros inteligente, o dashboard completo, e todos os detalhes arquiteturais necessários para compreensão integral do sistema.